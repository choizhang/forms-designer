<!DOCTYPE HTML>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>ueditor demo</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="third-party/zTreeStyle.css">
    <style>
        .current {
            color: #ff0000;
        }

        .domain .icon {
            width: 30px;
            height: 31px;
        }
    </style>
</head>

<body>

<a href="javascript:;" class="add">增加一个视图</a>

<script type="text/javascript" src="third-party/jquery-1.10.2.js"></script>
<script type="text/javascript" src="third-party/jquery.ztree.core.js"></script>

<ul class="navigation">
    <li class="current">视图1</li>
</ul>
<ul class="content">
    <li>
        <!-- 加载编辑器的容器 -->
        <script id="container" name="content" type="text/plain">这里写你的初始化内容




        </script>
    </li>
</ul>

<div>
    <h2>我是域结构</h2>

    <a href="javascript:;">我是链接</a>

    <ul class="domain">
        <li>域1</li>
        <li>域2</li>
        <li class="li">
            <div style="position: relative;width: 71px;">
                <img src="text.png" alt="文本" title="文本" class="icon">
                <span style="position: absolute;right: 5px;top: 7px;">姓名</span>
            </div>
        </li>
    </ul>

    <ul id="treeDemo" class="ztree"></ul>
</div>


<!-- 配置文件 -->
<script type="text/javascript" src="ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="ueditor.all.js"></script>
<script type="text/javascript" src="addCustomizeButton.js"></script>
<script type="text/javascript" src="addCustomizeCombox.js"></script>
<script type="text/javascript" src="addCustomizeDialog.js"></script>
<!-- 实例化编辑器 -->
<script type="text/javascript">
    var ues = [];
    ues[0] = UE.getEditor('container', {
//            toolbars: [
//                ['fullscreen', 'source', 'undo', 'redo', 'bold']
//            ],
//        shortcutMenu: [],
        allowDivTransToP: false,
        autoHeightEnabled: true,
        autoFloatEnabled: true,
//            分隔线替代文字
//        pageBreakTag: '\<hr class="pagebreak" noshade="noshade" size="5" style="-webkit-user-select: none;">'
    });

    $(function () {
//        $('#test').draggable();
        var index = 1;
        var ss = '<li><script id="container$1" name="content$1" type="text/plain"><\/script></li>';
        var dd = '<li>视图$1</li>';
        $('.add').on('click', function () {
            index++;
            $('.content').append(ss.replace(/\$1/g, index));
            $('.navigation').append(dd.replace(/\$1/g, index))
            ues[index - 1] = UE.getEditor('container' + index);

            $("#treeDemo").trigger('addTag', {isParent: true, name: '视图', nodes: undefined});

//            先增加在选中

            $('.navigation').find('li').last().trigger('click');
        })

        $('.navigation').on('click', 'li', function () {
            $('.navigation').find('.current').removeClass('current')
            var num = $(this).addClass('current').index();
            $('.content').find('li').hide().eq(num).show();

            var nodes = zTreeObj.getNodes();
            if (nodes.length > 0) {
                zTreeObj.selectNode(nodes[num]);
            }
        })
    });
</script>
<script>
    var zTreeObj;
    // zTree 的参数配置，深入使用请参考 API 文档（setting 配置详解）
    var setting = {
        callback: {
            onClick: function (event, treeId, treeNode) {
                $('iframe').contents().find('#editorComp_' + treeNode.id).click();
            }
        }
    };
    // zTree 的数据属性，深入使用请参考 API 文档（zTreeNode 节点数据详解）
    var zNodes = [
//        {
//            name: "视图1",
//            open: true,
//            children: [
//                {name: "test1_1"},
//                {name: "test1_2"}
//            ]
//        }
//        {
//            name: "test2",
//            open: true,
//            children: [
//                {name: "test2_1"},
//                {name: "test2_2"}
//            ]
//        }
    ];
    $(document).ready(function () {
//        因为iframe的初始化需要时间,所以要做一个延迟
        setTimeout(function () {
            var iframeBody = $($('iframe')[0].contentWindow.document.body);
            iframeBody.on('click', '.component-handle', function (e) {
                var el = $(this).closest('.component');

                el.prop('draggable', true)
//                el.prop('draggable', !el.prop('draggable'))

                var range = document.createRange();
//                range.selectNodeContents(el[0]);
                range.selectNode(el[0]);

                var window = $('iframe')[0].contentWindow;
                var sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);

                e.stopPropagation();
            })

            iframeBody.on('click', function (e) {
                var $comp = iframeBody.find('.component');
                $comp.prop('draggable', false);
            })

//            iframeBody.on('dragstart', '.component', function (e) {
//                console.log('dragstart', e)
//                e.originalEvent.dataTransfer.dropEffect = 'move';
//            });

            iframeBody.on('dragover', '.component', function (e) {
//                console.log('drop', e)

//                这样设置了就让组件不能拖到组件内部,还是不行
//                e.preventDefault();
//
//                e.originalEvent.dataTransfer.dropEffect = 'move';
            });

            iframeBody.on('dragend', '.component', function (e) {
                console.log('dragend', e)

                var dataTransfer = e.originalEvent.dataTransfer;

                if (dataTransfer.dropEffect === 'none') {
//                    此次拖拽是失败的

                } else {
//                    拖拽成功,不知道在哪里设置,只能手动删除原来的
                    console.log(e.currentTarget)
                    $(e.currentTarget).remove();
                }

//                如果多个组件嵌套
                e.stopPropagation();
            });
        }, 1000)


        zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, zNodes);


        //    动态增加一个子节点

        window.newCount = 1;
//        function add(e) {
//            var isParent = e.data.isParent,
//                    nodes = zTreeObj.getSelectedNodes(),
//                    treeNode = nodes[0];
//            if (treeNode) {
//                treeNode = zTreeObj.addNodes(treeNode, {id:(100 + newCount), pId:treeNode.id, isParent:isParent, name:"new node" + (newCount++)});
//            } else {
//                treeNode = zTreeObj.addNodes(null, {id:(100 + newCount), pId:0, isParent:isParent, name:"new node" + (newCount++)});
//            }
//            if (treeNode) {
////                zTreeObj.editName(treeNode[0]);
//            } else {
//                alert("叶子节点被锁定，无法增加子节点");
//            }
//        };

        $('#treeDemo').on('addTag', function (e, args) {
//            var
////                    nodes = zTreeObj.getSelectedNodes(),
//                    nodes = args.nodes,
//                    treeNode = nodes[0];

            if (!args) {
                args = {};
                args.isParent = e.isParent;
                args.name = e.name;
                args.nodes = e.nodes;
            }

            var treeNode = args.nodes;

            if (treeNode) {
                treeNode = zTreeObj.addNodes(treeNode, {
                    id: (100 + newCount),
                    pId: treeNode.id,
                    isParent: args.isParent,
                    name: args.name + (newCount++)
                });
            } else {
                treeNode = zTreeObj.addNodes(null, {
                    id: (100 + newCount),
                    pId: 0,
                    isParent: args.isParent,
                    name: args.name + (newCount++)
                });
            }
            if (treeNode) {
//                zTreeObj.editName(treeNode[0]);
            } else {
                alert("叶子节点被锁定，无法增加子节点");
            }

            return treeNode;
        })

        $("#treeDemo").trigger('addTag', {isParent: true, name: '视图', nodes: undefined});

//        $("#addParent").on("click", {isParent:true}, add);
//        $("#addLeaf").on("click", {isParent:false}, add);

//    点击子节点选中相应组件

//    双击弹窗设置
    });

</script>

</body>

</html>